<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout — CATHARTEK</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <a href="index.html" class="logo">CATHAR<span>TEK</span></a>
      <nav>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
        </ul>
      </nav>
      <a href="cart.html" class="cart-link">
        Cart
        <span class="cart-count" id="cartCount">0</span>
      </a>
    </div>
  </header>

  <main class="checkout-page">
    <div class="container">
      <h1>Checkout</h1>

      <div id="checkoutContent">
        <!-- Filled by JS: form + order summary, or empty-cart message -->
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="footer-inner">
        <div>
          <h4>Shop</h4>
          <ul>
            <li><a href="products.html?category=pc">Pre-built PCs</a></li>
            <li><a href="products.html?category=components">Components</a></li>
            <li><a href="products.html?category=peripherals">Peripherals</a></li>
            <li><a href="products.html?category=accessories">Accessories</a></li>
          </ul>
        </div>
        <div>
          <h4>Support</h4>
          <ul>
            <li><a href="#">Contact</a></li>
            <li><a href="#">Shipping & returns</a></li>
            <li><a href="#">FAQ</a></li>
          </ul>
        </div>
        <div>
          <h4>Company</h4>
          <ul>
            <li><a href="#">About us</a></li>
            <li><a href="#">Careers</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">© CATHARTEK. All rights reserved.</div>
    </div>
  </footer>

  <script>

    function renderCheckout() {
      const cart = getCart();
      const container = document.getElementById('checkoutContent');

      if (cart.length === 0) {
        container.innerHTML = `
          <div class="cart-empty">
            <p>Your cart is empty.</p>
            <a href="products.html" class="btn btn-primary">Shop products</a>
          </div>
        `;
        return;
      }

      const subtotal = cart.reduce((sum, i) => sum + i.price * (i.qty || 1), 0);

      container.innerHTML = `
        <div class="checkout-grid">
          <div class="checkout-form-wrap">
            <form id="checkoutForm" class="checkout-form" novalidate>
              <fieldset class="form-section">
                <legend>Contact</legend>
                <label for="email">Email</label>
                <input type="email" id="email" name="email" required placeholder="you@example.com">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" placeholder="Optional">
              </fieldset>
              <fieldset class="form-section">
                <legend>Shipping address</legend>
                <label for="name">Full name</label>
                <input type="text" id="name" name="name" required placeholder="Your name">
                <label for="address">Address</label>
                <input type="text" id="address" name="address" required placeholder="Street address">
                <label for="address2">Address line 2</label>
                <input type="text" id="address2" name="address2" placeholder="Flat, building, etc. (optional)">
                <div class="form-row">
                  <div>
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" required placeholder="City">
                  </div>
                  <div>
                    <label for="postcode">Postcode</label>
                    <input type="text" id="postcode" name="postcode" required placeholder="Postcode">
                  </div>
                </div>
                <label for="country">Country</label>
                <input type="text" id="country" name="country" required placeholder="United Kingdom" value="United Kingdom">
              </fieldset>
              <p class="form-note">You’ll be redirected to our secure payment provider to complete your purchase.</p>
              <button type="submit" class="btn btn-primary btn-block">Continue to payment</button>
            </form>
          </div>
          <div class="checkout-summary">
            <h2 class="checkout-summary-title">Order summary</h2>
            <ul class="checkout-items">
              ${cart.map((i) => `
                <li>
                  <span class="checkout-item-name">${i.name} × ${i.qty || 1}</span>
                  <span class="checkout-item-price">$${(i.price * (i.qty || 1)).toFixed(2)}</span>
                </li>
              `).join('')}
            </ul>
            <div class="checkout-total">
              <span>Total</span>
              <span>$${subtotal.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `;

      document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'Redirecting to payment...';
        }
        const data = {
          email: form.email.value.trim(),
          phone: form.phone.value.trim(),
          name: form.name.value.trim(),
          address: form.address.value.trim(),
          address2: form.address2.value.trim(),
          city: form.city.value.trim(),
          postcode: form.postcode.value.trim(),
          country: form.country.value.trim(),
          items: getCart(),
          total: subtotal,
        };
        try {
          const response = await fetch('/api/create-checkout-session', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
          });

          if (!response.ok) {
            throw new Error('Failed to start checkout');
          }

          const result = await response.json();

          if (result && result.url) {
            window.location.href = result.url;
          } else {
            throw new Error('No payment URL returned');
          }
        } catch (error) {
          console.error('Checkout error:', error);
          alert('There was a problem starting the payment. Please try again in a moment.');
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Continue to payment';
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const cart = getCart();
      document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + (i.qty || 1), 0);
      renderCheckout();
    });
  </script>
  <script src="js/main.js"></script>
</body>
</html>
